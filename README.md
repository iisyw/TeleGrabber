# TeleGrabber

TeleGrabber 是一个 Telegram 机器人，用于自动保存接收到的图片。当你的机器人收到图片、图册或图片文件时，它会自动下载并保存这些内容到本地文件系统。

## 功能特点

- 自动下载并保存 Telegram 消息中的图片
- 支持单张图片和多张图片组（相册）
- 支持作为图片文件发送的图片
- 实时状态更新和处理进度提示
- 按照用户名和日期自动组织文件夹
- 简洁文件名与 CSV 元数据分离，方便管理
- 内置重试机制和代理支持，适应不同网络环境
- 优化的媒体组处理，避免重复消息

## 项目结构

```
telegrabber/
│
├── main.py          # 主程序入口
├── bot.py           # 机器人核心功能
├── config.py        # 配置管理
├── utils.py         # 工具函数
├── requirements.txt # 依赖列表
├── env.example      # 环境变量模板
└── README.md        # 项目说明
```

## 安装方法

1. 克隆此仓库：

```bash
git clone https://github.com/yourusername/telegrabber.git
cd telegrabber
```

2. 安装依赖：

```bash
pip install -r requirements.txt
```

3. 创建配置文件：

```bash
# 复制配置模板
cp env.example .env

# 编辑配置文件，填入你的Telegram机器人令牌
nano .env  # 或者使用你喜欢的文本编辑器
```

## 如何获取 Telegram 机器人令牌

1. 在 Telegram 中搜索 [@BotFather](https://t.me/BotFather)
2. 发送命令 `/newbot` 并按照提示创建一个新机器人
3. 完成后，BotFather 会提供一个令牌（格式类似 `123456789:ABCDEFGHIJKLMNOPQRSTUVWXYZ`）
4. 将此令牌复制到 `.env` 文件中的 `TELEGRAM_BOT_TOKEN=` 后面

## 网络问题解决方案

如果你在中国大陆或其他网络受限区域，可能无法直接连接到 Telegram API。你可以通过在`.env`文件中设置代理来解决:

```
# 使用SOCKS5代理
PROXY_URL=socks5h://127.0.0.1:1080

# 或者使用HTTP代理
# PROXY_URL=http://127.0.0.1:8124
```

你需要确保已安装代理支持:

```bash
pip install pysocks
```

## 使用方法

运行机器人：

```bash
python main.py
```

机器人启动后，你可以向它发送以下内容：

- 单张图片：机器人将下载并保存，并回复确认消息
- 多张图片（相册）：机器人将显示收集状态，然后保存所有图片
- 图片文件：机器人会检查文件类型，只保存图片文件

所有图片将保存在 `downloads` 目录下（或你在 `.env` 中指定的其他目录），按照用户名/日期的层级结构组织。

## 媒体组处理机制

当用户发送多张图片（媒体组/相册）时：

1. 机器人会先发送"正在收集媒体组图片，请稍候..."的状态消息
2. 系统会在后台收集所有属于同一媒体组的图片（默认等待 2 秒钟）
3. 收集完成后，会在原始状态消息上更新处理进度（例如"正在保存图片组：1/10"）
4. 所有图片保存完毕后，会显示完成状态和用时

这种机制确保了：

- 用户界面整洁，不会因每张图片都发送单独消息而造成刷屏
- 用户能够看到实时进度，了解处理状态
- 相册中的所有图片都能被正确识别并保存

## 配置选项

在`.env`文件中可设置以下选项：

```
# 必填：Telegram机器人令牌
TELEGRAM_BOT_TOKEN=your_token_here

# 可选：代理设置（如需要）
PROXY_URL=http://127.0.0.1:8124

# 可选：保存目录（默认为 ./downloads）
SAVE_DIR=./my_images

# 可选：日志级别（默认为 INFO）
LOG_LEVEL=INFO
```

## 命令

- `/start` - 启动机器人并收到欢迎消息
- `/help` - 获取帮助信息

## 高级配置

如果你想调整媒体组收集的等待时间（默认为 2 秒），可以在`bot.py`中修改：

```python
# 修改这个值可以调整收集媒体组的等待时间（秒）
MEDIA_GROUP_COLLECT_TIME = 2
```

- 增加这个值可以确保在慢速网络下收集完整媒体组
- 减少这个值可以加快处理速度，但可能在某些情况下漏掉图片

## 图片命名与元数据管理

TeleGrabber 使用优化的文件命名方案，保持文件名可追踪性，同时保存完整元数据信息：

### 文件命名规则

- 媒体组图片：`{完整媒体组ID}_{时间戳}{扩展名}`
  例如：`13991698976443269_1686834561723.jpg` 或 `.png` 等
- 单张图片：`single_{时间戳}{扩展名}`
  例如：`single_1686834561723.jpg` 或 `.webp` 等
- 文档类图片：`doc_{时间戳}{扩展名}`
  例如：`doc_1686834561723.png` 或 `.gif` 等

时间戳为毫秒级数字格式（13 位数字），如`1686834561723`，代表精确到毫秒的 UNIX 时间戳，确保在短时间内连续保存的图片也能有唯一文件名。

与旧版本不同，现在系统会自动检测每张图片的实际格式，并使用正确的文件扩展名（如 .jpg、.png、.gif、.webp 等），不再强制使用 .jpg 扩展名。

使用完整的媒体组 ID 可以确保不同媒体组有独特的标识，完全避免冲突。

### 元数据管理

所有图片的详细信息都保存在 CSV 文件中，包括：

- 文件名
- 保存时间
- Telegram 文件 ID
- Telegram 文件唯一 ID
- 媒体组 ID (如适用)

CSV 文件按日期组织，存储在用户目录下：`{用户名}/{日期}_metadata.csv`

这种设计有以下优势：

- 保存完整的追踪信息
- 便于按日期或其他元数据查询
- 可以轻松恢复原始 Telegram 关联
